#!/bin/bash
set -e

ROOT_DIR="$(pwd)"
SETUP_DIR="$ROOT_DIR/Setup"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ–¨ï¸ UI helper
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print_step()
{
	echo
	echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	echo "$1"
	echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  ç³»çµ±åµæ¸¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
detect_system()
{
	OS="$(. /etc/os-release; echo $ID)"
	DE="${XDG_CURRENT_DESKTOP:-$DESKTOP_SESSION}"
	SESSION_TYPE="${XDG_SESSION_TYPE:-}"

	if [[ -z "$SESSION_TYPE" ]]; then
		SESSION_TYPE="x11"
	fi

	echo "ğŸ” åµæ¸¬ç³»çµ±è³‡è¨Šï¼š"
	echo "- OSï¼š$OS"
	echo "- æ¡Œé¢ç’°å¢ƒï¼š$DE"
	echo "- é¡¯ç¤ºå”è­°ï¼š$SESSION_TYPE"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â“ ä½¿ç”¨è€…ç¢ºèª
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
confirm_continue()
{
	read -rp "ä»¥ä¸Šè³‡è¨Šæ˜¯å¦æ­£ç¢ºï¼Ÿæ˜¯å¦ç¹¼çºŒå®‰è£ï¼Ÿ[Y/N] " ans
	[[ "$ans" =~ ^[Yy]$ ]] || exit 0
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”§ Backup
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
backup_path()
{
	local target="$1"
	[[ ! -e "$target" ]] && return
	local bak="${target}.bak.$(date +%s)"
	cp -r "$target" "$bak"
	echo "ğŸ§· å·²å‚™ä»½ $target â†’ $bak"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ å¥—ä»¶
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_packages()
{
	print_step "ğŸ“¦ å®‰è£ fcitx5 / rime å¥—ä»¶"

	case "$OS" in
		fedora) CMD="sudo dnf install -y --refresh" ;;
		arch*) CMD="sudo pacman -S --noconfirm" ;;
		ubuntu*|debian*) CMD="sudo apt install -y" ;;
		*) echo "âŒ ä¸æ”¯æ´ç³»çµ±"; exit 1 ;;
	esac

	$CMD fcitx5 fcitx5-rime fcitx5-configtool git
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ› ï¸ Rime data
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_rime_data()
{
	print_step "ğŸ› ï¸ å®‰è£ Rime schema / è©åº«"
	sudo cp -v *.yaml /usr/share/rime-data/
	sudo cp -rv opencc /usr/share/rime-data/ || true
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âŒ¨ï¸ é¸æ“‡è¼¸å…¥æ³•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
select_input_methods()
{
	print_step "âŒ¨ï¸ é¸æ“‡è¦å•Ÿç”¨å˜…è¼¸å…¥æ³•"

	echo "å¯å¤šé¸ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼‰ï¼š"
	echo "1) å€‰é ¡äº”ä»£"
	echo "2) å€‰é ¡äº”ä»£ï¼ˆé€²éšï¼‰"
	echo "3) é€Ÿæˆ"
	echo "4) ç²µæ‹¼"

	read -rp "è«‹è¼¸å…¥ç·¨è™Ÿ: " choices

	RIME_CFG="$HOME/.local/share/fcitx5/rime"
	mkdir -p "$RIME_CFG"
	backup_path "$RIME_CFG/default.custom.yaml"

	{
		echo "patch:"
		echo "  schema_list:"
		for c in $choices; do
			case "$c" in
				1) echo "    - schema: cangjie5" ;;
				2) echo "    - schema: cangjie5_advanced" ;;
				3)

